{"version":3,"sources":["webpack:///D:/project/fuintUniapp/pages/login/components/mp-weixin.vue?0f7c","webpack:///D:/project/fuintUniapp/pages/login/components/mp-weixin.vue?047a","webpack:///D:/project/fuintUniapp/pages/login/components/mp-weixin.vue?cfda","webpack:///D:/project/fuintUniapp/pages/login/components/mp-weixin.vue?f34b","uni-app:///pages/login/components/mp-weixin.vue","webpack:///D:/project/fuintUniapp/pages/login/components/mp-weixin.vue?cbb8","webpack:///D:/project/fuintUniapp/pages/login/components/mp-weixin.vue?98a0"],"names":["components","WxPrivacy","data","code","needPhone","isProfile","isOpenPrivacy","agreePrivacy","protocolTitle","protocolSubDesc","ProtocolEnum","SettingKeyEnum","created","methods","privacyChange","openPrivacy","handleDisagree","handleAgree","getCode","uni","provider","success","console","resolve","fail","getUserSetting","UserApi","then","app","catch","getUserProfile","wx","lang","desc","userInfo","getPhoneNumber","onAuthSuccess","store","scene","client","mobile","password","setTimeout","onEmitSuccess","oauth","$emit","cancelLogin","onNavigateBack","delta"],"mappings":";;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAkI;AAClI;AAC6D;AACL;AACsC;;;AAG9F;AACsK;AACtK,gBAAgB,6KAAU;AAC1B,EAAE,+EAAM;AACR,EAAE,gGAAM;AACR,EAAE,yGAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,oGAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACvBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAqnB,CAAgB,mnBAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;;ACsCzoB;AACA;AAEA;AACA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;eACA;EACAA;IACAC;EACA;EACAC;IACA;MACA;MACA;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;IACA;EACA;EAEAC;IACA;IACA;;IAEA;IACA;EACA;EAEAC;IACAC;MACA;IACA;IACAC;MACA;QACA;QACA;MACA;QACA;QACA;MACA;MACA;IACA;IACAC;MACA;MACA;IACA;IACAC;MACA;MACA;IACA;IAEA;IACA;IACAC;MACA;QACAC;UACAC;UACAC;YACAC;YACAC;UACA;UACAC;QACA;MACA;IACA;IAEAC;MACA;MACA;QACAC,kBACAC;UACAC;QACA,GACAC;UACA;QAAA,CACA;MACA;IACA;IAEA;IACAC;MACA;MACA;QACAF;QACA;MACA;MACAG;QACAC;QACAC;QACAZ;UAAA;UACAC;UACA;YACAM;UACA;UACA;UACAM;UACAN;QACA;QACAJ;UACAF;UACAM;QACA;MACA;IACA;IAEA;IACAO;MACA;QACA;UAAA;UAAA;UAAA;UAAA;QAAA;MACA;IACA;IAEA;IACA;IACA;IACA;IACAC;MAAA;MAAA;QAAA;QAAA;UAAA;YAAA;cAAA;gBACAR,aACA;gBAAA,cAKAS;gBAAA;gBAAA;cAAA;gBAAA;gBAAA;kBAAAlC;kBAAAmC;kBAAAC;kBAAAC;kBAAAC;gBAAA;gBAAA,iEACAd;kBACAL;kBACA;oBACA;oBACAM;oBACA;oBACAc;sBACAd;oBACA;kBACA;oBACAS;kBACA;gBACA,GACAR;kBACA;kBACAD;gBACA;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IACA;IAEA;IACA;IACAe;MAAA;MAAA;QAAA;QAAA;UAAA;YAAA;cAAA;gBACAf;gBAAA,eACAA;gBAAA;gBAAA,OAEAA;cAAA;gBAAA;gBAAA,eACAM;gBAAA;kBAFAU;kBACAzC;kBACA+B;gBAAA;gBAAA,aAHAW;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IAKA;IAEA;AACA;AACA;IACAC;MACA;MACA;IACA;IAEA;AACA;AACA;IACAC;MAAA;MACA5B;QACA6B;MACA;IACA;EACA;AACA;AAAA,2B;;;;;;;;;;;;;ACtNA;AAAA;AAAA;AAAA;AAAosC,CAAgB,0nCAAG,EAAC,C;;;;;;;;;;;ACAxtC;AACA,OAAO,KAAU,EAAE,kBAKd","file":"pages/login/components/mp-weixin.js","sourcesContent":["import { render, staticRenderFns, recyclableRender, components } from \"./mp-weixin.vue?vue&type=template&id=3aaf109c&scoped=true&\"\nvar renderjs\nimport script from \"./mp-weixin.vue?vue&type=script&lang=js&\"\nexport * from \"./mp-weixin.vue?vue&type=script&lang=js&\"\nimport style0 from \"./mp-weixin.vue?vue&type=style&index=0&id=3aaf109c&lang=scss&scoped=true&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"3aaf109c\",\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/login/components/mp-weixin.vue\"\nexport default component.exports","export * from \"-!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--17-0!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./mp-weixin.vue?vue&type=template&id=3aaf109c&scoped=true&\"","var components\nvar render = function () {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./mp-weixin.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./mp-weixin.vue?vue&type=script&lang=js&\"","<template>\r\n  <view class=\"container\">\r\n    <view class=\"wechatapp\">\r\n      <view class=\"header\">\r\n        <open-data class=\"avatar\" type=\"userAvatarUrl\"></open-data>\r\n      </view>\r\n    </view>\r\n    <view class=\"auth-title\">申请获取以下权限</view>\r\n    <view v-if=\"isProfile\">\r\n      <view class=\"auth-subtitle\">获得您微信绑定的手机号码</view>\r\n      <view class=\"login-btn\">\r\n        <button class=\"button-mobile btn-primary\" open-type=\"getPhoneNumber\"\r\n          @getphonenumber=\"getPhoneNumber\">授权手机号</button>\r\n      </view>\r\n    </view>\r\n    <view v-if=\"!isProfile\">\r\n      <view class=\"auth-subtitle\">获得你的公开信息（昵称、头像等）</view>\r\n      <view class=\"login-btn\">\r\n        <button class=\"button btn-normal\" @click.stop=\"getUserProfile\">授权登录</button>\r\n      </view>\r\n    </view>\r\n    <view class=\"no-login-btn\">\r\n      <button class=\"button btn-normal\" @click=\"cancelLogin\">暂不登录</button>\r\n    </view>\r\n    <view class=\"privacy\">\r\n      <label @click=\"privacyChange\">\r\n        <checkbox :checked=\"agreePrivacy\" value=\"agree\" color=\"#fa2209\" style=\"transform:scale(0.7)\" />已阅读并同意\r\n      </label>\r\n      <text class=\"privacy-ptl\" @click=\"openPrivacy(1)\">《隐私协议》</text>\r\n      <text class=\"member-ptl\" @click=\"openPrivacy(2)\">《用户协议》</text>\r\n      <wx-privacy ref=\"popPrivacy\" @agree=\"handleAgree\" :title=\"protocolTitle\" :subDesc=\"protocolSubDesc\"\r\n        @disagree=\"handleDisagree\"></wx-privacy>\r\n    </view>\r\n\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport store from '@/store'\r\nimport * as UserApi from '@/api/user'\r\nimport WxPrivacy from './wx-privacy'\r\nimport ProtocolEnum from '@/common/enum/protocol/Protocol'\r\nimport SettingKeyEnum from '@/common/enum/setting/Key'\r\nexport default {\r\n  components: {\r\n    WxPrivacy\r\n  },\r\n  data() {\r\n    return {\r\n      // 微信小程序登录凭证 (code)\r\n      // 提交到后端，用于换取openid\r\n      code: '',\r\n      needPhone: false,\r\n      isProfile: false,\r\n      isOpenPrivacy: false,\r\n      agreePrivacy: false,\r\n      protocolTitle: '',\r\n      protocolSubDesc: '',\r\n      ProtocolEnum,\r\n      SettingKeyEnum\r\n    }\r\n  },\r\n\r\n  created() {\r\n    // 获取code\r\n    this.getCode()\r\n\r\n    // 获取配置\r\n    this.getUserSetting()\r\n  },\r\n\r\n  methods: {\r\n    privacyChange() {\r\n      this.agreePrivacy = !this.agreePrivacy;\r\n    },\r\n    openPrivacy(type) {\r\n      if (type == 1) {\r\n        this.protocolTitle = ProtocolEnum.data[0].name;\r\n        this.protocolSubDesc = ProtocolEnum.data[0].value;\r\n      } else {\r\n        this.protocolTitle = ProtocolEnum.data[1].name;\r\n        this.protocolSubDesc = ProtocolEnum.data[1].value;\r\n      }\r\n      this.$refs.popPrivacy.openPrivacy();\r\n    },\r\n    handleDisagree() {\r\n      this.agreePrivacy = false;\r\n      this.$refs.popPrivacy.closePrivacy();\r\n    },\r\n    handleAgree() {\r\n      this.agreePrivacy = true;\r\n      this.$refs.popPrivacy.closePrivacy();\r\n    },\r\n\r\n    // 获取code\r\n    // https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html\r\n    getCode() {\r\n      return new Promise((resolve, reject) => {\r\n        uni.login({\r\n          provider: 'weixin',\r\n          success: res => {\r\n            console.log('getCode res = ', res)\r\n            resolve(res.code)\r\n          },\r\n          fail: reject\r\n        })\r\n      })\r\n    },\r\n\r\n    getUserSetting() {\r\n      const app = this\r\n      return new Promise((resolve, reject) => {\r\n        UserApi.setting()\r\n          .then(result => {\r\n            app.needPhone = result.data.loginNeedPhone === 'true' ? true : false\r\n          })\r\n          .catch(err => {\r\n            // empty\r\n          })\r\n      })\r\n    },\r\n\r\n    // 获取微信用户信息\r\n    getUserProfile() {\r\n      const app = this;\r\n      if (!app.agreePrivacy) {\r\n        app.$error(\"请仔细阅读《用户协议》和《隐私协议》，点击同意代表您已认上述协议内容！\");\r\n        return false;\r\n      }\r\n      wx.canIUse('getUserProfile') && wx.getUserProfile({\r\n        lang: 'zh_CN',\r\n        desc: '获取用户相关信息',\r\n        success({ userInfo }) {\r\n          console.log('userInfo == ', app)\r\n          if (app.needPhone) {\r\n            app.isProfile = true;\r\n          }\r\n          // 授权成功事件\r\n          userInfo.type = \"profile\";\r\n          app.onAuthSuccess(userInfo);\r\n        },\r\n        fail: function (res) {\r\n          console.log('登录授权失败，请设置小程序隐私保护协议，返回信息： ', res);\r\n          app.$error(\"抱歉，登录授权失败.\");\r\n        }\r\n      })\r\n    },\r\n\r\n    // 获取微信绑定的手机号\r\n    getPhoneNumber(e) {\r\n      if (e.detail.errMsg == \"getPhoneNumber:ok\") {\r\n        this.onAuthSuccess({ \"type\": \"phone\", \"encryptedData\": e.detail.encryptedData, \"iv\": e.detail.iv, \"sessionKey\": e.detail.iv })\r\n      }\r\n    },\r\n\r\n    // 授权成功事件\r\n    // 这里分为两个逻辑:\r\n    // 1.将code和userInfo提交到后端，如果存在该用户 则实现自动登录，无需再填写手机号\r\n    // 2.如果不存在该用户, 则显示注册页面, 需填写手机号\r\n    async onAuthSuccess(userInfo) {\r\n      const app = this\r\n      // 提交到后端\r\n\r\n\r\n\r\n\r\n      store.dispatch('MpWxLogin', { code: await app.getCode(), scene: \"mnp\", client: 1, mobile: \"\", password: \"\" })\r\n        .then(result => {\r\n          console.log(\"MpWxLogin_result\", result);\r\n          if (!app.needPhone) {\r\n            // 显示登录成功\r\n            app.$toast(result.message)\r\n            // 跳转回原页面\r\n            setTimeout(() => {\r\n              app.onNavigateBack()\r\n            }, 1000)\r\n          } else {\r\n            store.dispatch('Logout')\r\n          }\r\n        })\r\n        .catch(() => {\r\n          // 将oauth提交给父级\r\n          app.onEmitSuccess(userInfo)\r\n        })\r\n    },\r\n\r\n    // 将oauth提交给父级\r\n    // 这里要重新获取code, 因为上一次获取的code不能复用(会报错)\r\n    async onEmitSuccess(userInfo) {\r\n      const app = this\r\n      app.$emit('success', {\r\n        oauth: 'MP-WEIXIN', // 第三方登录类型: MP-WEIXIN\r\n        code: await app.getCode(), // 微信登录的code, 用于换取openid\r\n        userInfo // 微信用户信息\r\n      })\r\n    },\r\n\r\n    /**\r\n     * 暂不登录\r\n     */\r\n    cancelLogin() {\r\n      // 跳转回原页面\r\n      this.onNavigateBack();\r\n    },\r\n\r\n    /**\r\n     * 授权成功 跳转回原页面\r\n     */\r\n    onNavigateBack(delta = 1) {\r\n      uni.navigateBack({\r\n        delta: Number(delta)\r\n      })\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.container {\r\n  padding: 0 60rpx;\r\n  font-size: 32rpx;\r\n  background: #fff;\r\n  min-height: 100vh;\r\n}\r\n\r\n.wechatapp {\r\n  padding: 80rpx 0 48rpx;\r\n  border-bottom: 1rpx solid #e3e3e3;\r\n  margin-bottom: 72rpx;\r\n  text-align: center;\r\n\r\n  .header {\r\n    width: 190rpx;\r\n    height: 190rpx;\r\n    border: 4rpx solid #fff;\r\n    margin: 0 auto 0;\r\n    border-radius: 50%;\r\n    overflow: hidden;\r\n    box-shadow: 2rpx 0 10rpx rgba(50, 50, 50, 0.3);\r\n  }\r\n}\r\n\r\n.auth-title {\r\n  color: #585858;\r\n  font-size: 34rpx;\r\n  margin-bottom: 40rpx;\r\n}\r\n\r\n.auth-subtitle {\r\n  color: #888;\r\n  margin-bottom: 88rpx;\r\n  font-size: 28rpx;\r\n}\r\n\r\n.login-btn {\r\n  padding: 0 20rpx;\r\n\r\n  .button {\r\n    height: 88rpx;\r\n    line-height: 88rpx;\r\n    background: $fuint-theme;\r\n    color: #fff;\r\n    font-size: 30rpx;\r\n    border-radius: 12rpx;\r\n    text-align: center;\r\n  }\r\n\r\n  .button-mobile {\r\n    height: 88rpx;\r\n    line-height: 88rpx;\r\n    background: $fuint-theme;\r\n    color: #fff;\r\n    font-size: 30rpx;\r\n    border-radius: 12rpx;\r\n    text-align: center;\r\n  }\r\n}\r\n\r\n\r\n.no-login-btn {\r\n  margin-top: 24rpx;\r\n  padding: 0 20rpx;\r\n\r\n  .button {\r\n    height: 88rpx;\r\n    line-height: 88rpx;\r\n    background: #dfdfdf;\r\n    color: #fff;\r\n    font-size: 30rpx;\r\n    border-radius: 12rpx;\r\n    text-align: center;\r\n  }\r\n}\r\n\r\n.privacy {\r\n  margin-top: 50rpx;\r\n  padding-left: 5rpx;\r\n  font-size: 24rpx;\r\n  text-align: center;\r\n\r\n  .member-ptl {\r\n    color: $fuint-theme;\r\n  }\r\n\r\n  .privacy-ptl {\r\n    color: $fuint-theme;\r\n  }\r\n}\r\n</style>\r\n","import mod from \"-!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-2!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-3!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/sass-loader/dist/cjs.js??ref--8-oneOf-1-4!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-5!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./mp-weixin.vue?vue&type=style&index=0&id=3aaf109c&lang=scss&scoped=true&\"; export default mod; export * from \"-!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-2!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-3!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/sass-loader/dist/cjs.js??ref--8-oneOf-1-4!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-5!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./mp-weixin.vue?vue&type=style&index=0&id=3aaf109c&lang=scss&scoped=true&\"","// extracted by mini-css-extract-plugin\n    if(module.hot) {\n      // 1758976369556\n      var cssReload = require(\"D:/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/hmr/hotModuleReplacement.js\")(module.id, {\"hmr\":true,\"publicPath\":\"/\",\"locals\":false});\n      module.hot.dispose(cssReload);\n      module.hot.accept(undefined, cssReload);\n    }\n  "],"sourceRoot":""}